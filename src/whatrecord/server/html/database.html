<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WhatRecord? Startup Scripts</title>
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/split-grid/dist/split-grid.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
  <link rel="stylesheet" href="/_static/style.css">
  <!-- prod: <script src="https://cdn.jsdelivr.net/npm/vue@2"></script> -->
</head>
<body>

<div id="whatrec-database" class="top-grid">
  <div>
    <h2>{{ script_path }}</h2>
    <pre>
      <database-line v-for="line in lines"
         v-bind:lineno="line.lineno"
         v-bind:line="line.line"
      ></database-line>
    </pre>
  </div>
</div>

<script>

const WhatRecIOC = {
  data() {
    return {
      script_path: "",
      lines: [],
    }
  },
  mounted() {
    /* Split({}) */
    const url_params = new URLSearchParams(window.location.search);
    axios.get(
      "/api/database/get",
      {params:
        {
          filename: url_params.get("file")
        }
      }
    )
      .then(response => {
        this.script_path = url_params.get("file");
        this.lines = response.data;
      })
      .catch(error => {
        console.log(error)
      });
  },
  updated() {
    var hash = window.location.hash.substr(1);
    if (hash != "") {
      var obj = document.getElementById(hash);
      if (obj != null) {
        obj.scrollIntoView();
      }
    }
  }
}
const app = Vue.createApp(WhatRecIOC)


app.component('linter-results', {
  props: ["load_count", "errors", "warnings"],
  template: `
<div class="result-block">
  Records loaded: {{ load_count }}
</div>
<div class="error-block">
  <template v-for="error in errors" class="error-block">
    Error {{error.name}} Line {{error.line}}: {{error.message}}<br/>
  </template>
  <template v-for="warning in warnings" class="error-block">
    Warning {{warning.name}} Line {{warning.line}}: {{warning.message}}<br/>
  </template>
</div>
`
})

app.component('database-line', {
  props: ["lineno", "line"],
  template: `
    <div v-bind:id="lineno">{{ lineno }}: {{ line }}</div>
`
})

app.component('dictionary-table', {
  props: ["cls", "dict", "skip_keys"],
  template: `
  <table class="table" v-if="Object.keys(dict).length > 0">
    <thead v-bind:class="cls">
      <tr>
        <th>Item</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="(value, key) in dict" v-bind:key="key + '-' + value">
        <td v-bind:id="key">{{ key }}</td>

        <td v-if="skip_keys.indexOf(key) >= 0">
        </td>
        <td v-else-if="key == 'context'">
          <template v-for:="ctx in value">
            {{ ctx.name }}:{{ ctx.line }}<br/>
          </template>
        </td>
        <td v-else-if="key == 'metadata'">
          <dictionary-table
            :dict="value"
            :cls="'metadata'"
            :skip_keys="[]">
          </dictionary-table>
        </td>
        <td v-else>
          {{ value }}
        </td>
      </tr>
    </tbody>
  </table>
`
})


app.mount('#whatrec-database')

  </script>
</body>
</html>
