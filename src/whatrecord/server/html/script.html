<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WhatRecord? Startup Scripts</title>
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/split-grid/dist/split-grid.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
  <link rel="stylesheet" href="/_static/style.css">
  <!-- prod: <script src="https://cdn.jsdelivr.net/npm/vue@2"></script> -->
</head>
<body>

<div id="whatrec-ioc" class="top-grid">
  <div>
    <h2>{{ script_path }}</h2>
    <pre>
      <script-line v-for="line in lines"
         v-bind:argv="line.argv"
         v-bind:context="line.context"
         v-bind:error="line.error"
         v-bind:line="line.line"
         v-bind:outputs="line.outputs"
         v-bind:redirects="line.redirects"
         v-bind:result="line.result"
      ></script-line>
    </pre>
  </div>
</div>

<script>

const WhatRecIOC = {
  data() {
    return {
      script_path: "",
      lines: [],
    }
  },
  mounted() {
    /* Split({}) */
    const url_params = new URLSearchParams(window.location.search);
    axios.get(
      "/api/script/info",
      {params:
        {
          script: url_params.get("script")
        }
      }
    )
      .then(response => {
        this.script_path = response.data.script_path;
        this.lines = response.data.lines;
      })
      .catch(error => {
        console.log(error)
      });
  },
  updated() {
    var hash = window.location.hash.substr(1);
    if (hash != "") {
      console.log("hash is" + hash);
      var obj = document.getElementById(hash);
      if (obj != null) {
        obj.scrollIntoView();
      }
    }
  }
}
const app = Vue.createApp(WhatRecIOC)

app.component('db-context-link', {
  props: ["filename", "line"],
  template: `
  <a v-bind:href="'/database?file=' + filename + '#' + line" target="_blank">Line {{line}}</a>
`
})

app.component('linter-results', {
  props: ["load_count", "errors", "warnings"],
  template: `
<div class="result-block">
  Records loaded: {{ load_count }}
</div>
<div class="error-block">
  <template v-for="error in errors" class="error-block">
    <db-context-link v-bind:filename="error.file" v-bind:line=error.line></db-context-link>
    '{{error.name}}' error: {{error.message}}<br/>
  </template>
  <template v-for="warning in warnings" class="error-block">
    <db-context-link v-bind:filename="warning.file" v-bind:line=warning.line></db-context-link>
    '{{warning.name}}' warning: {{warning.message}}<br/>
  </template>
</div>
`
})

app.component('script-line', {
  props: ["context", "line", "outputs", "argv", "error", "redirects", "result"],
  template: `
  <details v-bind:id="context.map(({name, line}) => name + ':' + line).join(',')">
  <summary>
  <div v-if="error != null" class="script-error-line">
    {{ context.map(({name, line}) => line).join(':') }}: {{line}}
    <div class="error-block">{{ error }}</div>
  </div>
  <div v-else-if="result != null && result.hasOwnProperty('load_count') && (result.errors.length > 0 || result.warnings.length > 0)" class="script-error-line">
    {{ context.map(({name, line}) => line).join(':') }}: {{line}}
  </div>
  <div v-else class="script-line">
    {{ context.map(({name, line}) => line).join(':') }}: {{line}}
  </div>
  </summary>
  <template v-if="result != null">
    <template v-if="result.hasOwnProperty('load_count')">
      <linter-results
        v-bind:load_count="result.load_count"
        v-bind:errors="result.errors"
        v-bind:warnings="result.warnings"
      ></linter-results>
    </template>
    <template v-else>
      <div class="result-block">{{ result }}</div>
    </template>
  </template>
  </details>
`
})

app.component('dictionary-table', {
  props: ["cls", "dict", "skip_keys"],
  template: `
  <table class="table" v-if="Object.keys(dict).length > 0">
    <thead v-bind:class="cls">
      <tr>
        <th>Item</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="(value, key) in dict" v-bind:key="key + '-' + value">
        <td v-bind:id="key">{{ key }}</td>

        <td v-if="skip_keys.indexOf(key) >= 0">
        </td>
        <td v-else-if="key == 'context'">
          <template v-for:="ctx in value">
            {{ ctx.name }}:{{ ctx.line }}<br/>
          </template>
        </td>
        <td v-else-if="key == 'metadata'">
          <dictionary-table
            :dict="value"
            :cls="'metadata'"
            :skip_keys="[]">
          </dictionary-table>
        </td>
        <td v-else>
          {{ value }}
        </td>
      </tr>
    </tbody>
  </table>
`
})


app.mount('#whatrec-ioc')

  </script>
</body>
</html>
